name: Pull Request Checks
on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

# Add permissions for GitHub Pages deployment and PR comments
permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate PR
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para comparar cambios
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Run Tests
        run: ./gradlew check
      
      - name: Build Android Debug
        run: ./gradlew :androidApp:assembleDebug
      
      - name: Build Web
        run: ./gradlew :webApp:jsBrowserDevelopmentWebpack
      
      - name: Build Desktop
        run: ./gradlew :desktopApp:jar

  build-preview:
    runs-on: ubuntu-latest
    name: Build PR Preview
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Build Web Preview
        run: ./gradlew :webApp:jsBrowserProductionWebpack
      
      - name: Upload PR Preview Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-preview-${{ github.event.number }}
          path: ./webApp/build/distributions
          retention-days: 7
      
      - name: Comment PR with Build Success
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Check if build directory exists before trying to read it
            const buildPath = './webApp/build/distributions';
            let buildInfo = '';
            
            try {
              if (fs.existsSync(buildPath)) {
                const files = fs.readdirSync(buildPath);
                const jsFiles = files.filter(f => f.endsWith('.js'));
                const totalSize = files.reduce((sum, file) => {
                  const filePath = path.join(buildPath, file);
                  return sum + fs.statSync(filePath).size;
                }, 0);
                
                const sizeInKB = Math.round(totalSize / 1024);
                
                buildInfo = `ðŸ“¦ **Build Artifacts:**
                - Bundle Size: ~${sizeInKB} KB
                - Files Generated: ${files.length}
                - JS Bundles: ${jsFiles.length}`;
              } else {
                buildInfo = `ðŸ“¦ **Build Status:**
                - Build completed successfully
                - Artifacts are being processed`;
              }
            } catch (error) {
              console.log('Error reading build directory:', error.message);
              buildInfo = `ðŸ“¦ **Build Status:**
              - Build completed successfully
              - Artifacts are available for download`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ **PR Preview Built Successfully!**
              
              ${buildInfo}
              
              ðŸ“ **Download Preview**: Check the workflow artifacts to download the built web application.
              
              â„¹ï¸ *Note: GitHub Pages deployment requires additional repository permissions. The build is successful and artifacts are available for download.*`
            })

  size-check:
    runs-on: ubuntu-latest
    name: Bundle Size Check
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Build Web Bundle
        run: ./gradlew :webApp:jsBrowserProductionWebpack
      
      - name: Check Bundle Size
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          find webApp/build/distributions -name "*.js" -exec basename {} \; -exec stat -f%z {} \; | paste - - | while read file size; do
            echo "| $file | $(numfmt --to=iec-i --suffix=B $size) |" >> $GITHUB_STEP_SUMMARY
          done