name: Pull Request Checks
on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate PR
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para comparar cambios
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Run Tests
        run: ./gradlew check
      
      - name: Build Android Debug
        run: ./gradlew :androidApp:assembleDebug
      
      - name: Build Web
        run: ./gradlew :webApp:jsBrowserDevelopmentWebpack
      
      - name: Build Desktop
        run: ./gradlew :desktopApp:jar

  build-preview:
    runs-on: ubuntu-latest
    name: Build PR Preview
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Build Web Preview
        run: ./gradlew :webApp:jsBrowserProductionWebpack
      
      - name: Deploy PR Preview
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./webApp/build/distributions
          destination_dir: pr-${{ github.event.number }}
      
      - name: Comment PR with Preview Link
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸŽ‰ **Preview deployed!** \n\nðŸ“± Web Preview: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.number }}/\n\n*This preview will be updated automatically with new commits.*'
            })

  size-check:
    runs-on: ubuntu-latest
    name: Bundle Size Check
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Build Web Bundle
        run: ./gradlew :webApp:jsBrowserProductionWebpack
      
      - name: Check Bundle Size
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          find webApp/build/distributions -name "*.js" -exec basename {} \; -exec stat -f%z {} \; | paste - - | while read file size; do
            echo "| $file | $(numfmt --to=iec-i --suffix=B $size) |" >> $GITHUB_STEP_SUMMARY
          done